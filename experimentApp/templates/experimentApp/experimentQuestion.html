<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>My test page</title>
    </head>
    <body>

        <noscript><h1 style="color: red;">Enable Javascript to use this application.</h1></noscript>

        <!-- Scripts/stylesheets -->
        {% load static %}
        <script type="text/javascript" src="{% static 'js/jquery.slim.min.js' %}"></script>
        <link rel="stylesheet" href="{% static 'css/focusImage.css' %}">

        <!-- Bootstrap 4  and overwrite -->
        <script type="text/javascript" src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="{% static 'css/page-css-override.css' %}">

        <!-- Dummy if custom colour is enabled -->
        {% if text_colour %}
            <div id="customColourEnabled"></div>
        {% endif %}

        <!-- Refresher image -->
        {% if time_shown %}
            <div id="refEnabled"></div>
        {% endif %}

        {% if rf_colour %}
            <div id="refCol" class="overlay" style="background-color: {{ rf_colour }};"></div>
        {% else %}
            {% if rf_image %}
                <img id="refImg" src="{{ rf_image.url }}" style="position: fixed; height: 100%; width: 100%; z-index: 100;">
            {% endif %}
        {% endif %}

        {% include 'header.html' %}

        <script>
            if(document.querySelector('#refEnabled')) {
                const time_shown = {{ time_shown }};

                if(document.querySelector('#refCol')) {
                    refCol.classList.toggle('covering');
                    setTimeout(function() {
                      refCol.classList.toggle('covering');
                    }, time_shown);
                } else {
                    setTimeout(function() {
                      refImg.hidden = true;
                    }, time_shown);
                }
            }
        </script>


        <!-- Page Content -->
        <div class="container" id="div_container">

            <h1 class="mt-4">{{ question.question_text }} </h1>

            {% if question_error_message %}<p class="colourText"><strong>{{ question_error_message }}</strong></p>{% endif %}


            <!-- Pairwise Comparison Question -->
            {% if question_type == 'pairwise-comparison' %}
                {% if groundTruth %}
                    {% if experiment_type == 'image' %}
                        <p class="colourText">Below is the original image.</p>
                        <img src="{{ groundTruth.choice_image.url }}" alt="img" onclick="focusImage(this);" class="gt_file">
                        <br>
                    {% else %}
                        <p class="colourText">Below is the original video.</p>
                        <video class="gt_file" controls>
                            <source src="{{ groundTruth.choice_image.url }}" type="video/mp4">
                        </video>
                        <br>
                    {% endif %}
                {% endif %}

                {% if experiment_type == 'image' %}
                    <p class="colourText">Select one image from the following which looks best to you. Spend time examining each one, you can enlarge an
                    image to its original resolution by clicking on it.</p>
                {% else %}
                    <p class="colourText">Select one video from the following which looks best to you. Spend time examining each one - you can play, pause,
                    replay and enlarge each video.</p>
                {% endif %}


                <form action="{% url 'experimentApp:vote' experiment_slug question.question_num %}" method="post">
                    {% csrf_token %}

                    <table>

                        {% for row in choice_list %}
                            <tr>
                                {% for choice in row %}
                                    <td style="padding: 5px 5px 5px 5px;">
                                        {% if experiment_type == 'image' %}
                                            <img src="{{ choice.choice_image.url }}" onclick="focusImage(this);" class="pc_files"/>
                                        {% else %}
                                            <video class="pc_files" controls>
                                                <source src="{{ choice.choice_image.url }}" type="video/mp4">
                                            </video>
                                        {% endif %}

                                        <p style="text-align: center;">
                                            <input type="radio" name="choice" id="choice{{ forloop.counter }}{{forloop.parentloop.counter}}" value="{{ choice.id }}">
                                            <label class="colourText" for="choice{{ forloop.counter }}{{forloop.parentloop.counter}}">{{ choice.choice_text }}</label>
                                        </p>
                                    </td>
                            {% endfor %}
                            </tr>
                        {% endfor %}

                    </table>
                    <input type="submit" class="btn btn-outline-primary btn-lg" value="Next Question">
                </form>

                <script>
                    // Resizes images to have max 4 on each horizontal row, only decreasing their resolution, will
                    // not increase their resolution
                    window.addEventListener('resize', resizeImages);
                    resizeImages();

                    function resizeImages() {
                        var pc_files = document.getElementsByClassName("pc_files");
                        var num_images_in_row = pc_files.length;

                        if(num_images_in_row > 4) {
                            num_images_in_row = 4;
                        }

                        const screen_width = $("#div_container").css('max-width');
                        let image_width = ((parseInt(screen_width) - 30) / num_images_in_row) - 10;

                        if(image_width < pc_files[0].width) {
                            for(var i = 0; i < pc_files.length; i++) {
                                pc_files[i].width = image_width;
                            }

                            const gt_file = document.getElementsByClassName("gt_file");
                            if(gt_file[0] != undefined) {
                                gt_file[0].width = image_width;
                            }
                        }
                    }
                </script>

            {% endif %}


            <!-- Ranking Question -->
            {% if question_type == 'RANKING' %}

                {% load static %}
                <link rel="stylesheet" href="{% static 'css/table.css' %}">
                <script type="text/javascript" src="{% static 'js/Sortable.min.js' %}"></script>

                {% if groundTruth %}
                    {% if experiment_type == 'image' %}
                        <p class="colourText">Below is the original image.</p>
                        <br>
                        <img src="{{ groundTruth.choice_image.url }}" alt="img"  onclick="focusImage(this);" class="gt_file">
                        <br>
                    {% else %}
                        <p class="colourText">Below is the original video.</p>
                        <video class="gt_file" controls>
                            <source src="{{ groundTruth.choice_image.url }}" type="video/mp4">
                        </video>
                        <br>
                    {% endif %}
                {% endif %}

                {% if experiment_type == 'image' %}
                    <p id="imageText" class="colourText">Below is a list of images. Sort these images by how good they look to you. Place your best one at the top,
                    and the worst at the bottom. You change the ordering by holding and dragging the handle to the left of every
                    image. Spend time examining each one, you can enlarge an
                        image to its original resolution by clicking on it.</p>
                {% else %}
                    <p class="colourText">Below is a list of images. Sort these images by how good they look to you. Place your best one at the top,
                    and the worst at the bottom. You change the ordering by holding and dragging the handle to the left of every
                    image. Spend time examining each one - you can play, pause, replay and enlarge each video.</p>
                {% endif %}


                <form action="{% url 'experimentApp:vote' experiment_slug question.question_num %}" id="orderingForm" method="post">
                    {% csrf_token %}

                    <table>
                        <tbody id="groups">
                            {% for choice in ranking_set %}
                                <tr data-lookup="{{ choice.pk }}">
                                    <td style="padding: 0px 5px 0px 5px;">
                                        <span class="handle"></span>
                                    </td>
                                    <td style="padding: 5px 5px 5px 5px;">
                                        <p class="colourText">{{ choice.choice_text }}</p>
                                        {% if experiment_type == 'image' %}
                                            <img src="{{ choice.choice_image.url }}" onclick="focusImage(this); viewImage(this);" class="rk_files"
                                                id="rankingChoice{{ forloop.counter }}"/>
                                        {% else %}
                                            <video id="rankingChoice{{ forloop.counter }}" class="rk_files" controls>
                                                <source src="{{ choice.choice_image.url }}" type="video/mp4">
                                            </video>
                                        {% endif %}


                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <button id="saveOrdering" class="btn btn-outline-primary btn-lg mt-4" disabled>Save ordering</button>
                    <input type="hidden" id="orderingInput" name="ordering">
                </form>

                <script>
                    // Allows images to be dragged by the user to be sorted
                    let sortable = Sortable.create(groups, {
                        handle: '.handle',
                        dragClass: 'dragged',
                        chosenClass: 'sortableChosen',
                    });

                    const saveOrderingButton = document.getElementById('saveOrdering');
                    const orderingForm = document.getElementById('orderingForm');
                    const formInput = orderingForm.querySelector('#orderingInput');

                    saveOrderingButton.addEventListener('click', saveOrdering);

                    function saveOrdering() {
                        const rows = document.getElementById("groups").querySelectorAll('tr');
                        let ids = [];
                        for (let row of rows) {
                            ids.push(row.dataset.lookup);
                        }
                        formInput.value = ids.join(',');
                        orderingForm.submit();
                    }

                    // Resizes images
                    window.addEventListener('resize', resizeImages);
                    resizeImages();

                    function resizeImages() {
                        const rk_files = document.getElementsByClassName("rk_files");
                        const screen_width = $("#div_container").css('max-width');

                        let image_width = -1;
                        if(parseInt(screen_width, 10) >= 1400) {
                            image_width = 200;
                        } else if(parseInt(screen_width, 10) >= 1200) {
                            image_width = 175;
                        } else {
                            image_width = 150;
                        }

                        for(var i = 0; i < rk_files.length; i++) {
                            rk_files[i].width = image_width;
                        }
                        const gt_file = document.getElementsByClassName("gt_file");
                        if(gt_file[0] != undefined) {
                            gt_file[0].width = image_width;
                        }
                    }

                    // Tracks which images haven't been viewed by the user
                    if(document.getElementById("imageText")) {
                        const rk_files = document.getElementsByClassName("rk_files");
                        var rk_files_not_viewed = [];
                        for(var i = 0; i < rk_files.length; i++) {
                            rk_files_not_viewed.push(rk_files[i].id);
                        }

                        function viewImage(image) {
                            const index = rk_files_not_viewed.indexOf(image.id);
                            if(index != -1) {
                                rk_files_not_viewed.splice(index, 1);
                            }
                            if(rk_files_not_viewed.length == 0) {
                                document.getElementById('saveOrdering').disabled = false;
                            }
                        }
                    } else {
                        document.getElementById('saveOrdering').disabled = false;
                    }
                </script>
            {% endif %}


            {% if question_type == 'RATING' %}
                {% if groundTruth %}
                    {% if experiment_type == 'image' %}
                        <p class="colourText">Below is the original image.</p>
                        <br>
                        <img src="{{ groundTruth.choice_image.url }}" alt="img" class="gt_file">
                        <br>
                    {% else %}
                        <p class="colourText">Below is the original video.</p>
                        <video class="gt_file" controls>
                            <source src="{{ groundTruth.choice_image.url }}" type="video/mp4">
                        </video>
                        <br>
                    {% endif %}
                {% endif %}


                {% if select_choice == 'INPUT_FIELD' %}
                    <p class="colourText">Choose value rating for each image between {{ range_lower_bound }} - {{ range_upper_bound }}</p>


                    <form action="{% url 'experimentApp:vote' experiment_slug question.question_num %}" method="post">
                        {% csrf_token %}
                        <table>
                            {% for row in rating_list %}
                                <tr>
                                    {% for rating in row %}
                                        <td style="padding: 5px 5px 5px 5px;">
                                            {% if experiment_type == 'image' %}
                                                <img src="{{ rating.choice_image.url }}" onclick="focusImage(this);" class="rt_files" choice_text="{{ rating.choice_text }}"/>
                                            {% else %}
                                                <video class="rt_files" choice_text="{{ rating.choice_text }}" controls>
                                                    <source src="{{ rating.choice_image.url }}" type="video/mp4">
                                                </video>
                                            {% endif %}

                                            <p style="text-align: center;">
                                                <input name="rating" id="rating{{ forloop.counter }}{{forloop.parentloop.counter}}" class="rt_inputs">
                                                <label class="colourText" for="rating{{ forloop.counter }}{{forloop.parentloop.counter}}">{{ rating.choice_text }}</label>
                                            </p>
                                        </td>
                                {% endfor %}
                                </tr>
                            {% endfor %}
                        </table>
                        <input type="submit" class="btn btn-outline-primary btn-lg" value="Next Question">
                    </form>

                <script>
                    // Adds reference from each image to respective input field
                    const rt_image_list = document.getElementsByClassName("rt_files");
                    const input_field_list = document.querySelectorAll('[id^="rating"]');

                    for(var i = 0; i < rt_image_list.length; i++) {
                        rt_image_list[i].input_field_ref = input_field_list[i];
                    }

                    // Images will be ordered in the code in their proper ordering, thus the following query
                    // will simply get all image inputs in their order
                    const rt_inputs = document.getElementsByClassName("rt_inputs");

                    // Naming performed in javascript as images are ordered in [[row]] in Django
                    for(var i = 0; i < rt_inputs.length; i++) {
                        rt_inputs[i].name = "ratingChoice".concat(i.toString());
                    }


                    // Resizes images to have max 4 on each horizontal row, only decreasing their resolution, will
                    // not increase their resolution
                    window.addEventListener('resize', resizeImages);
                    resizeImages();

                    function resizeImages() {
                        var rt_files = document.getElementsByClassName("rt_files");
                        var num_images_in_row = rt_files.length;

                        if(num_images_in_row > 4) {
                            num_images_in_row = 4;
                        }

                        const screen_width = $("#div_container").css('max-width');
                        let image_width = ((parseInt(screen_width) - 30) / num_images_in_row) - 10;

                        if(image_width < rt_files[0].width) {
                            for(var i = 0; i < rt_files.length; i++) {
                                rt_files[i].width = image_width;
                            }

                            const gt_file = document.getElementsByClassName("gt_file");
                            if(gt_file[0] != undefined) {
                                gt_file[0].width = image_width;
                            }
                        }
                    }
                </script>


                {% endif %}

                {% if select_choice == 'RADIO' %}
                    {% load experiment_extras %}
                    <p class="colourText">Choose a rating for each image from the given values.</p>

                    <form action="{% url 'experimentApp:vote' experiment_slug question.question_num %}" method="post">
                        {% csrf_token %}
                        <table>
                            {% for rating in rating_list %}
                            <tr>
                                <td style="padding: 5px 5px 5px 5px; vertical-align: top;">
                                    {% if experiment_type == 'image' %}
                                        <img src="{{ rating.choice_image.url }}" onclick="focusImage(this);" class="rt_files" choice_text="{{ rating.choice_text }}"/>
                                    {% else %}
                                        <video class="rt_files" choice_text="{{ rating.choice_text }}" controls>
                                            <source src="{{ rating.choice_image.url }}" type="video/mp4">
                                        </video>
                                    {% endif %}
                                </td>
                                <td style="padding: 5px 5px 5px 5px;">
                                    {% for index in num_radio_choices|get_range %}
                                        <input type="radio" name="{{ forloop.parentloop.counter0 }}ratingChoiceRadio{{ forloop.counter0 }}"
                                               id="{{ forloop.parentloop.counter0 }}ratingChoiceRadio{{ forloop.counter0 }}">
                                        <label class="colourText" for="{{ forloop.parentloop.counter0 }}ratingChoiceRadio{{ forloop.counter0 }}">{{ forloop.counter0 }}</label>
                                        <br>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                        <input type="submit" class="btn btn-outline-primary btn-lg" value="Next Question">
                    </form>

                    <script>
                        // Resizes images to constant size
                        const rt_files = document.getElementsByClassName("rt_files");
                        let image_width = 275;

                        for(var i = 0; i < rt_files.length; i++) {
                            rt_files[i].width = image_width;
                        }

                        const gt_file = document.getElementsByClassName("gt_file");
                        if(gt_file[0] != undefined) {
                            gt_file[0].width = image_width;
                        }
                    </script>
                {% endif %}


                {% if select_choice == 'SLIDER' %}
                    <p class="colourText">Choose value rating for each image between {{ range_lower_bound }} - {{ range_upper_bound }}</p>

                    <form action="{% url 'experimentApp:vote' experiment_slug question.question_num %}" method="post">
                        {% csrf_token %}
                        <table>
                            {% for row in rating_list %}
                                <tr>
                                    {% for rating in row %}
                                        <td style="padding: 5px 5px 5px 5px;">
                                            {% if experiment_type == 'image' %}
                                                <img src="{{ rating.choice_image.url }}" onclick="focusImage(this);" class="rt_files" choice_text="{{ rating.choice_text }}"/>
                                            {% else %}
                                                <video class="rt_files" choice_text="{{ rating.choice_text }}" controls>
                                                    <source src="{{ rating.choice_image.url }}" type="video/mp4">
                                                </video>
                                            {% endif %}

                                            <div class="slidecontainer" style="text-align: center">
                                                <label for="ratingChoiceSlider{{ forloop.counter0 }}{{ forloop.parentloop.counter0 }}" class="colourText">{{ rating.choice_text }}</label>
                                                <br>
                                                <input type="range" min="{{ range_lower_bound }}" max="{{ range_upper_bound }}" class="slider"
                                                       id="ratingChoiceSlider{{ forloop.counter0 }}{{ forloop.parentloop.counter0 }}"
                                                       oninput="updateSliderValue.call(this)">
                                                <p class="colourText">Value: <span id="sliderValue{{ forloop.counter0 }}{{ forloop.parentloop.counter0 }}"></span></p>
                                            </div>
                                        </td>
                                {% endfor %}
                                </tr>
                            {% endfor %}
                        </table>
                        <input type="submit" class="btn btn-outline-primary btn-lg" value="Next Question">
                    </form>

                    <script>
                        // Dynamically displays value associated with each slider
                        var rt_image_list = document.getElementsByClassName("rt_files");
                        var slider = document.querySelectorAll('[id^="ratingChoiceSlider"]');
                        var slider_value = document.querySelectorAll('[id^="sliderValue"]');

                        for(var i = 0; i < slider.length; i++) {
                            slider[i].slider_val = slider_value[i];
                            slider_value[i].innerHTML = slider[i].value;

                            // Name values so backend can query them in order
                            slider[i].name = "ratingChoiceSlider".concat(i.toString());

                            // Reference from image to slider
                            rt_image_list[i].sliderRef = slider[i];
                        }

                        function updateSliderValue(e) {
                            this.slider_val.innerHTML = this.value;
                        }

                        // Resizes images to have max 4 on each horizontal row, only decreasing their resolution, will
                        // not increase their resolution
                        window.addEventListener('resize', resizeImages);
                        resizeImages();

                        function resizeImages() {
                            const rt_files = document.getElementsByClassName("rt_files");
                            var num_images_in_row = rt_files.length;

                            if(num_images_in_row > 4) {
                                num_images_in_row = 4;
                            }

                            const screen_width = $("#div_container").css('max-width');
                            let image_width = ((parseInt(screen_width) - 30) / num_images_in_row) - 10;

                            if(image_width < rt_files[0].width) {
                                for(var i = 0; i < rt_files.length; i++) {
                                    rt_files[i].width = image_width;
                                }

                                const gt_file = document.getElementsByClassName("gt_file");
                                if(gt_file[0] != undefined) {
                                    gt_file[0].width = image_width;
                                }
                            }
                        }
                    </script>

                {% endif %}

            {% endif %}

        </div>

        <!-- Cover used for focusing attention on enlarged image -->
        <div id="cover" onclick="un_focusImage()"></div>

        <img src="" id="enlargedImage" class="centered" onclick="un_focusImage()" hidden>
        <div id="enlargedImageCaption" style="position: fixed; z-index: 101; top: 50%; left: 50%; text-align: center" hidden>
            <label for="enlargedImage" id="enlargedImageCaptionLabel" style="color: white"></label>
            <br>

            <!-- Input field/Slider -->
            <input id="enlargedImageInput" oninput="updateEnlargeInput(this)" hidden>
            <p id="enlargedImageSliderValueContainer" style="color: white" hidden>Value: <span id="enlargedImageSliderValue"></span></p>

        </div>


        <script>

            /* Updates text colours if necessary */
            if(document.getElementById('customColourEnabled')) {
                const text_colour = '{{ text_colour }}';
                const text_elements = document.getElementsByClassName("colourText");
                for(var i = 0; i < text_elements.length; i++) {
                    text_elements[i].style.color = text_colour;
                }

                var h1s = document.getElementsByTagName("h1");
                for(var i = 0; i < h1s.length; i++) {
                    h1s[i].style.color = text_colour;
                }

                const background_colour = '{{ background_colour }}';
                document.body.style.backgroundColor = background_colour;
            }

            // Allows image to be viewed at its original resolution and fades out rest of website upon clicking
            function focusImage(e) {
                cover.classList.toggle('covering');

                document.querySelector("#enlargedImage").src = e.src;
                document.querySelector("#enlargedImage").hidden = false;

                // Show caption in focused view
                document.querySelector("#enlargedImageCaption").hidden = false;
                document.querySelector("#enlargedImageCaptionLabel").innerHTML = e.getAttribute("choice_text");
                const enlargedImgHeight = document.querySelector("#enlargedImage").height / 2;
                document.querySelector("#enlargedImageCaption").style.transform = "translate(-50px, " + enlargedImgHeight + "px)";

                // If this is a rating experiment with sliders, we include the sliders in the focused view
                if(document.getElementsByClassName("slider").length != 0) {

                    // Show necessary inputs
                    const inputElem = document.querySelector("#enlargedImageInput");
                    inputElem.hidden = false;
                    const valueElemCon = document.querySelector("#enlargedImageSliderValueContainer");
                    valueElemCon.hidden = false;

                    inputElem.type = "range";
                    inputElem.min = e.sliderRef.min;
                    inputElem.max = e.sliderRef.max;
                    inputElem.origRef = e.sliderRef;

                    const valueElem = document.querySelector("#enlargedImageSliderValue");
                    valueElem.hidden = false;
                    valueElem.innerHTML = e.sliderRef.value;
                    console.log(e.sliderRef.value);
                    inputElem.value = e.sliderRef.value;
                    inputElem.slider_val = valueElem;

                } else if(document.getElementsByClassName("rt_inputs").length != 0) {
                    // Show necessary inputs
                    const inputElem = document.querySelector("#enlargedImageInput");
                    inputElem.hidden = false;

                    inputElem.type = "";
                    inputElem.origRef = e.input_field_ref;
                    inputElem.value = e.input_field_ref.value;
                }
            }

            /* Removes focused image */
            function un_focusImage() {
                cover.classList.toggle('covering');

                document.querySelector("#enlargedImage").hidden = true;
                document.querySelector("#enlargedImageCaption").hidden = true;

                document.querySelector("#enlargedImageSliderValue").hidden = true;
                document.querySelector("#enlargedImageSliderValueContainer").hidden = true;
            }

            // Updates original field when updating cloned field for enlarged image
            function updateEnlargeInput(e) {

                // If this question takes slider inputs
                if(document.getElementsByClassName("slider").length != 0) {
                    e.origRef.value = e.value;
                    e.origRef.slider_val.innerHTML = e.value;

                    e.slider_val.innerHTML = e.value;
                } else if(document.getElementsByClassName("rt_inputs").length != 0) {
                    e.origRef.value = e.value;
                }
            }
        </script>

    </body>
</html>
